<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Google Maps vs ViaCEP</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a87; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Debug: Google Maps vs ViaCEP</h1>
        
        <!-- Teste ViaCEP -->
        <div class="section">
            <h2>ViaCEP (Funciona bem)</h2>
            <input type="text" id="cep-input" placeholder="Digite um CEP (ex: 01310-100)" maxlength="9">
            <button onclick="testViaCEP()">Testar ViaCEP</button>
            <div id="viacep-result" class="result"></div>
        </div>
        
        <!-- Teste Google Maps -->
        <div class="section">
            <h2>Google Maps (Problema)</h2>
            <input type="text" id="address-input" placeholder="Digite um endereço (ex: Rua Hipólito da Costa)" style="width: 400px;">
            <button onclick="testGoogleMaps()">Testar Google Maps</button>
            <div id="google-result" class="result"></div>
        </div>
        
        <!-- Comparação -->
        <div class="section">
            <h2>Comparação de Estruturas</h2>
            <div id="comparison" class="result"></div>
        </div>
    </div>

    <script>
        let googleMapsService;
        let apiKey;
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/config/google-maps.php');
                const config = await response.json();
                apiKey = config.api_key;
                
                if (apiKey) {
                    // Carregar Google Maps API
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initGoogleMaps`;
                    document.head.appendChild(script);
                } else {
                    document.getElementById('google-result').innerHTML = '<p style="color: red;">API Key do Google Maps não configurada</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar configuração:', error);
            }
        });
        
        function initGoogleMaps() {
            googleMapsService = new google.maps.places.PlacesService(document.createElement('div'));
            console.log('Google Maps API carregada');
        }
        
        async function testViaCEP() {
            const cep = document.getElementById('cep-input').value.replace(/\D/g, '');
            const resultDiv = document.getElementById('viacep-result');
            
            if (cep.length !== 8) {
                resultDiv.innerHTML = '<p style="color: red;">CEP deve ter 8 dígitos</p>';
                return;
            }
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <h3>Dados ViaCEP:</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                    <h3>Estrutura Normalizada:</h3>
                    <pre>{
  "logradouro": "${data.logradouro || ''}",
  "numero": "",
  "bairro": "${data.bairro || ''}",
  "cidade": "${data.localidade || ''}",
  "estado": "${data.uf || ''}",
  "cep": "${data.cep || ''}"
}</pre>
                `;
                
                updateComparison('viacep', data);
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">Erro: ${error.message}</p>`;
            }
        }
        
        function testGoogleMaps() {
            const address = document.getElementById('address-input').value;
            const resultDiv = document.getElementById('google-result');
            
            if (!googleMapsService) {
                resultDiv.innerHTML = '<p style="color: red;">Google Maps não carregado</p>';
                return;
            }
            
            if (!address.trim()) {
                resultDiv.innerHTML = '<p style="color: red;">Digite um endereço</p>';
                return;
            }
            
            const request = {
                query: address + ', Brasil',
                fields: ['place_id', 'formatted_address', 'address_components', 'geometry']
            };
            
            googleMapsService.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                    const place = results[0];
                    
                    resultDiv.innerHTML = `
                        <h3>Dados Google Maps (Raw):</h3>
                        <pre>${JSON.stringify(place, null, 2)}</pre>
                        <h3>Address Components:</h3>
                        <pre>${JSON.stringify(place.address_components, null, 2)}</pre>
                        <h3>Estrutura Normalizada:</h3>
                        <pre>${JSON.stringify(parseGoogleMapsResult(place), null, 2)}</pre>
                    `;
                    
                    updateComparison('google', place);
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">Erro: ${status}</p>`;
                }
            });
        }
        
        function parseGoogleMapsResult(place) {
            const result = {
                logradouro: '',
                numero: '',
                bairro: '',
                cidade: '',
                estado: '',
                cep: ''
            };
            
            if (place.address_components) {
                place.address_components.forEach(component => {
                    const types = component.types;
                    
                    if (types.includes('route')) {
                        result.logradouro = component.long_name;
                    } else if (types.includes('street_number')) {
                        result.numero = component.long_name;
                    } else if (types.includes('sublocality_level_1') || types.includes('sublocality_level_2') || types.includes('sublocality') || types.includes('neighborhood')) {
                        if (!result.bairro) result.bairro = component.long_name;
                    } else if (types.includes('political') && !result.bairro) {
                        result.bairro = component.long_name;
                    } else if (types.includes('locality')) {
                        result.cidade = component.long_name;
                    } else if (types.includes('administrative_area_level_2') && !result.cidade) {
                        result.cidade = component.long_name;
                    } else if (types.includes('administrative_area_level_1')) {
                        result.estado = component.short_name;
                    } else if (types.includes('postal_code')) {
                        result.cep = component.long_name;
                    }
                });
            }
            
            return result;
        }
        
        let comparisonData = {};
        
        function updateComparison(source, data) {
            comparisonData[source] = data;
            
            if (comparisonData.viacep && comparisonData.google) {
                const viacepNormalized = {
                    logradouro: comparisonData.viacep.logradouro || '',
                    numero: '',
                    bairro: comparisonData.viacep.bairro || '',
                    cidade: comparisonData.viacep.localidade || '',
                    estado: comparisonData.viacep.uf || '',
                    cep: comparisonData.viacep.cep || ''
                };
                
                const googleNormalized = parseGoogleMapsResult(comparisonData.google);
                
                document.getElementById('comparison').innerHTML = `
                    <h3>Comparação Normalizada:</h3>
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 1;">
                            <h4>ViaCEP:</h4>
                            <pre>${JSON.stringify(viacepNormalized, null, 2)}</pre>
                        </div>
                        <div style="flex: 1;">
                            <h4>Google Maps:</h4>
                            <pre>${JSON.stringify(googleNormalized, null, 2)}</pre>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>